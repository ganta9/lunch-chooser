# 失敗事例・バグ記録

## 概要
このファイルはLunch Decider（Webアプリ版）の開発過程で発生した失敗事例、バグ、問題点を記録し、同様の問題の再発防止を図るためのものです。

## 記録フォーマット
各事例は以下の形式で記録してください：

```
### [日付] 問題タイトル
**症状**: 何が起きたか
**原因**: なぜ起きたか  
**解決策**: どう解決したか
**予防策**: 今後の対策
**影響範囲**: どこに影響したか
```

---

## セキュリティ問題と対応 (2025-08-16)

### 2025-08-16 APIキーのハードコーディングによる機密情報漏洩
**症状**: slack-lunch-deciderプロジェクトでGoogle Sheets APIキーを`script.js`に直接記述し、GitHubで公開
**原因**: セキュリティ意識不足、開発時の利便性優先
**解決策**: 
- 古いAPIキー即座無効化
- 新しいAPIキー作成（制限付き）
- プロジェクト名変更（lunch-chooser）
- 環境変数ベース設定システム実装
- GitHub Actionsでの動的config.js生成
**予防策**: 
- .gitignore最初設定
- 機密情報の環境変数化徹底
- セキュリティレビュー習慣化
**影響範囲**: Google Sheets API、全体のセキュリティ
**ステータス**: ✅ 解決済み

---

## GitHub Pages + GitHub Actions デプロイ問題 (2025-08-16)

### 2025-08-16 GitHub Pages設定ミスによる404エラー
**症状**: 「There isn't a GitHub Pages site here」404エラー
**原因**: Source設定が「Deploy from a branch」のまま
**解決策**: Settings → Pages → Source を「GitHub Actions」に変更
**予防策**: デプロイ設定チェックリストの作成
**影響範囲**: サイト全体の公開
**ステータス**: ✅ 解決済み

### 2025-08-16 config.js生成・読み込み問題
**症状**: サイト表示されるが「config.js が読み込まれていません」エラー
**原因**: GitHub ActionsでのHEREDOC環境変数展開問題
**試行錯誤**:
1. `cat > config.js << EOF` - 環境変数展開問題
2. `cat > config.js << 'EOF'` - GitHub Secretsが展開されない
3. `echo文による行単位生成` - 明示的環境変数設定で解決見込み
**解決策**: 環境変数を明示的に設定し、echo文で行単位生成
**予防策**: デバッグログ充実、段階的テスト
**影響範囲**: Google Sheets API接続、アプリ機能全体
**ステータス**: 🔄 対応中

### 2025-08-16 GitHub Actions権限設定問題
**症状**: GitHub Actions実行時の権限エラー
**原因**: デフォルトの読み取り専用権限
**解決策**: 
- Settings → Actions → General → Workflow permissions を「Read and write permissions」に設定
- Pages deployment用権限追加
**予防策**: 権限設定の標準化
**影響範囲**: CI/CDパイプライン
**ステータス**: ✅ 解決済み

---

## 既知の潜在的問題点

### 2024-08-15 週次ジャンル制限の境界条件
**症状**: 金曜日に全ジャンルを使い切った場合の処理
**原因**: 仕様段階での検討不足
**解決策**: 実装済み - 条件に合う店舗がない場合のアラート表示
**予防策**: 条件フィルタリング後の結果チェック処理を実装済み
**影響範囲**: ランダム選択ロジック
**ステータス**: ✅ 解決済み

### 2024-08-15 データ整合性の問題
**症状**: JavaScript内データ定義の手動編集時のシンタックスエラー
**原因**: 手動データ編集によるヒューマンエラー
**解決策**: GitHubエディタでのシンタックスハイライト活用
**予防策**: データ編集時の慎重な確認、テスト実行
**影響範囲**: 店舗データ読み込み、アプリケーション全体
**ステータス**: 🔄 継続監視

### 2024-08-15 ローカルストレージの制限
**症状**: ブラウザによるローカルストレージ容量制限
**原因**: 長期間の履歴蓄積によるデータサイズ増大
**解決策**: 履歴リセット機能の提供
**予防策**: 定期的な履歴整理の推奨
**影響範囲**: 履歴管理機能
**ステータス**: 🔄 継続監視

### 2024-08-15 CORS問題（解決済み）
**症状**: ローカルファイルでJSONファイル読み込み時のCORSエラー
**原因**: ブラウザのセキュリティ制限
**解決策**: JSONデータをJavaScript内に移動
**予防策**: 外部ファイル依存の回避
**影響範囲**: データ読み込み全般
**ステータス**: ✅ 解決済み

### 2024-08-15 週の開始日の認識ズレ
**症状**: システムの週開始日とユーザーの認識に差がある可能性
**原因**: 週の開始日を月曜日と仮定
**解決策**: 実装済み - 今週利用状況で月〜金を明示
**予防策**: UI上で週開始日を明確に表示
**影響範囲**: 週次履歴管理、ジャンル制限
**ステータス**: ✅ 解決済み

---

## 実際の失敗事例

### 2024-08-15 Google Sheets API連携での複数の問題
**症状**: スプレッドシートからのデータ読み込みが全く動作しない
**原因**: 複数の設定ミスが重複
**解決策**: 段階的な問題切り分けとテスト
**影響範囲**: Google Sheets連携機能全体
**ステータス**: ✅ 解決済み

#### 詳細な失敗の流れ:

**第1段階: API権限エラー**
- **エラー**: `ERR_CONNECTION_CLOSED`、`Unable to retrieve header`
- **原因**: APIキーの制限設定が不適切
- **問題**: HTTPリファラー設定が正しくない
- **解決**: APIキー制限を一時的に「なし」に設定してテスト

**第2段階: スプレッドシートアクセス権限**
- **エラー**: `Method doesn't allow unregistered callers`、`PERMISSION_DENIED`
- **原因**: スプレッドシートが非公開設定のまま
- **解決**: スプレッドシートを「リンクを知っている全員」に変更

**第3段階: シート名の不一致**
- **エラー**: `Unable to parse range: Sheet1!A1:J100`、`INVALID_ARGUMENT`
- **原因**: 日本語シート名「シート1」を「Sheet1」として指定
- **解決**: スプレッドシートのシート名を「Sheet1」に変更

**第4段階: データ構造の仕様変更**
- **症状**: 開発途中でスプレッドシート構造を変更
- **原因**: 当初の評価者・星評価の列設計が非効率
- **解決**: 1人1列形式に構造変更、コードも対応

### 2024-08-15 プロジェクト方針の大幅変更
**症状**: 開発途中でSlackアプリからWebアプリに方向転換
**原因**: 企業のSlack制限により当初の仕様が実現不可
**解決策**: 全面的な仕様変更とドキュメント見直し
**影響範囲**: プロジェクト全体
**ステータス**: ✅ 解決済み

#### 変更内容:
- **技術スタック**: Slack API → Pure Web (HTML/CSS/JavaScript)
- **データ管理**: サーバー不要のクライアントサイド実装
- **デプロイ**: Heroku等 → GitHub Pages
- **全ドキュメント**: Slack前提からWeb前提に全面書き直し

### 2024-08-15 新規開拓の確率バランス問題
**症状**: 新規開拓が選択される確率が高すぎる
**原因**: 新規開拓の星評価を3.0に設定（他店舗と同レベル）
**解決策**: パラメータ化と調整可能な仕組みを実装
**影響範囲**: ランダム選択ロジック
**ステータス**: ✅ 解決済み

### 2024-08-15 初期のCORS問題
**症状**: ローカルファイルでJSONファイル読み込み時にCORSエラー
**原因**: ブラウザのセキュリティ制限
**解決策**: JSONデータをJavaScript内に直接記述
**影響範囲**: 初期のデータ読み込み機能
**ステータス**: ✅ 解決済み（後にGoogle Sheets APIで置き換え）

## 学んだ教訓

### 技術的教訓
1. **API連携は段階的にテスト**: 権限→アクセス→データ形式の順で確認
2. **外部サービス連携は制約を事前調査**: 企業ポリシーの確認が重要
3. **データ構造は拡張性を考慮**: 後からの変更は影響範囲が大きい
4. **エラーメッセージの詳細確認**: ブラウザコンソールでの問題特定が重要

### プロジェクト管理の教訓
1. **要件変更への柔軟性**: 技術的制約で方向転換が必要な場合もある
2. **ドキュメントの整合性維持**: 仕様変更時の全面見直しが必要
3. **段階的リリース**: 基本機能→高度な機能の順で実装
4. **ユーザーフィードバックの重要性**: 確率調整等の細かい調整が必要

### デバッグ手法の教訓
1. **ブラウザ開発者ツールの活用**: コンソールエラーの詳細確認
2. **API直接テスト**: URLでの直接アクセステスト
3. **問題の切り分け**: 複数要因の問題は一つずつ解決
4. **設定の段階的適用**: 制限を一時解除してのテスト

---

## 今回のプロジェクトでの追加失敗事例

### 2024-08-17 Google Apps Script CORS問題（長期化）
**症状**: WebアプリからGoogle Apps ScriptへのAPI呼び出しでCORSエラーが継続発生
**原因**: ブラウザのCORSポリシーによる制限とGoogle Apps Scriptの設定不備
**解決策**: 最終的にJSONP方式を採用してCORSを完全回避
**影響範囲**: 共有履歴機能全体、チーム連携機能
**ステータス**: ✅ 解決済み

#### 詳細な失敗の流れ:

**第1段階: 基本的なCORS設定の試行**
- **エラー**: `Access-Control-Allow-Origin` ヘッダーがない
- **試行**: `createCORSResponse`関数でヘッダー追加
- **結果**: 依然としてCORSエラー継続

**第2段階: 複数回のデプロイとURL変更**
- **問題**: 新しいデプロイを作成してもCORSエラーが解決しない
- **試行**: 5回以上の新しいデプロイとURL更新
- **結果**: 根本的解決に至らず

**第3段階: doOptions関数の追加**
- **症状**: CORS preflight requestが失敗
- **試行**: `doOptions`関数を追加してOPTIONSメソッドに対応
- **結果**: 改善されずCORSエラー継続

**第4段階: シンプル化による原因特定の試行**
- **試行**: 最小限のテストコードでCORS設定を確認
- **問題**: Sheet2重複作成エラーが発生
- **結果**: 元のコードに戻すも根本解決せず

**第5段階: JSONP方式による最終解決**
- **手法**: fetchを使わずscriptタグによるJSONP通信
- **実装**: コールバック関数とURLパラメータによるデータ送信
- **結果**: ✅ CORS問題を完全回避、共有履歴機能実現

### 2024-08-17 週末対応要求への対応遅れ
**症状**: 土曜日のテストができないため、週末表示の要求
**原因**: 当初平日のみの仕様で設計
**解決策**: 月〜日の7日間表示に拡張
**影響範囲**: UI表示、JavaScript処理、CSS レイアウト
**ステータス**: ✅ 解決済み

### 2024-08-17 履歴データの日付バグ
**症状**: 履歴に2025年の間違った日付が記録される
**原因**: 古いテストデータまたはローカルストレージの不整合
**解決策**: `localStorage.clear()`による履歴リセット
**影響範囲**: 週次ジャンル管理の判定ロジック
**ステータス**: ✅ 解決済み

### 2024-08-17 チーム共有への期待と技術的制約のギャップ
**症状**: ユーザーがチーム共有機能を強く要望したが、CORS問題で実現困難
**原因**: 技術的制約の事前説明不足と代替案の検討不足
**解決策**: JSONP方式という技術的代替手段で最終的に実現
**影響範囲**: プロジェクト全体の方向性と完成度
**ステータス**: ✅ 解決済み

## 今回のプロジェクトから学んだ教訓

### 技術的教訓
1. **CORS問題は早期に代替手段を検討**: fetch/XMLHttpRequestでCORSエラーが出たら、即座にJSONP等の代替手段を検討
2. **Google Apps ScriptのCORS制限は厳しい**: 特にGitHub Pagesとの組み合わせでは制限が強い
3. **段階的デバッグの重要性**: 複雑な問題は最小単位に分解してテスト
4. **ユーザー要求への柔軟な対応**: 週末表示など、開発中の仕様変更要求に迅速対応

### プロジェクト管理の教訓
1. **技術制約の事前説明**: CORS等の技術的制約について、実装前にユーザーと共有
2. **代替案の準備**: 主要機能で技術的問題が発生した場合の代替手段を事前検討
3. **段階的リリース**: 基本機能→高度な機能の順で段階的に実装・テスト
4. **ユーザーとの期待値調整**: 技術的困難度と実現時期について適切な期待値設定

### デバッグ手法の教訓
1. **ブラウザ開発者ツールの活用**: ConsoleでのJavaScript実行とネットワーク監視
2. **複数ブラウザでのテスト**: Chrome、Firefox、Safariでの動作確認
3. **段階的実装**: 最小限の機能から徐々に拡張
4. **ログ出力の重要性**: `console.log`による詳細な状況把握

### コミュニケーションの教訓
1. **技術的問題の可視化**: CORSエラー等の画面を共有して状況を明確化
2. **解決策の段階的説明**: なぜその解決策を選択したかの説明
3. **進捗の透明性**: 試行錯誤の過程も含めて進捗を共有
4. **ユーザー参加型デバッグ**: ブラウザConsoleでの操作をユーザーに依頼

## 最新の失敗事例 (2025-08-16 続き)

### 2025-08-16 Google Apps Script JSONP競合状態エラー
**症状**: `ReferenceError: loadHistoryCallback_xxx is not defined`
**原因**: タイムアウト処理とJSONPコールバックの競合状態
**解決策**: 
- DOM要素存在確認の追加
- clearTimeout()による重複防止
- script要素の安全な削除処理
**予防策**: JSONP処理での厳密なリソース管理
**影響範囲**: 共有履歴読み込み（コアアプリは正常動作）
**ステータス**: ✅ 解決済み

### 2025-08-16 ローカルストレージ古データ混在問題
**症状**: Sheet2に土曜日データのみなのに、金曜日の古いデータも表示される
**原因**: 共有履歴とローカル履歴のマージ処理で古いローカルデータを残していた
**解決策**: 
- 共有履歴を完全優先する仕様に変更
- ローカル履歴マージ処理を廃止
- 共有履歴でローカルストレージを上書き同期
**予防策**: データソースの優先順位を明確化
**影響範囲**: 履歴表示の正確性
**ステータス**: ✅ 解決済み

### 2025-08-16 UI要素取得時のnull参照エラー
**症状**: `TypeError: Cannot read properties of null (reading 'name')`
**原因**: getElementById()の結果をnullチェックせずに使用
**解決策**: 全UI要素取得にnullチェック追加
**予防策**: 防御的プログラミングの徹底
**影響範囲**: ボタンクリック、スライダー操作等のUI全般
**ステータス**: ✅ 解決済み

### 2025-08-16 読み込み速度とユーザビリティ問題
**症状**: データ読み込み時間が長く、ユーザーが待機状況を把握できない
**原因**: 
- 逐次読み込みによる待機時間増大
- ローディング状況の非表示
- タイムアウト設定なし
**解決策**: 
- Promise.allSettledによる並列読み込み
- リアルタイムローディング表示
- 5秒タイムアウト設定
**予防策**: パフォーマンスとUXの両立を初期から考慮
**影響範囲**: アプリ全体の使用感
**ステータス**: ✅ 解決済み

### 2025-08-16 GitHub Repository Secrets設定不備
**症状**: config.jsは生成されるがAPIキーが未設定エラー
**原因**: GitHub Repository Secretsの設定漏れまたは値の不備
**解決策**: GitHub Secrets設定の再確認と正しい値の設定
**予防策**: デプロイ前のSecrets設定チェックリスト作成
**影響範囲**: API接続全般
**ステータス**: ✅ 解決済み

---

**記録ルール**:
- バグ発見時は必ず即座に記録する
- 解決後も記録を残し、予防策を更新する
- 定期的に過去の事例を見直し、類似問題の予防に努める
- 技術的制約と解決策の関係を明確に文書化する