<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://script.google.com https://script.googleusercontent.com;
        connect-src 'self' https://sheets.googleapis.com https://script.google.com https://script.googleusercontent.com;
        style-src 'self' 'unsafe-inline';
        img-src 'self' data:;
        font-src 'self';
        object-src 'none';
        base-uri 'self';
        form-action 'self';
    ">
    <title>Lunch Decider</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>🍽️ Lunch Decider</h1>
            <p>条件を選んでランチの場所を決めましょう！</p>
        </header>

        <main>
            <!-- 条件選択エリア -->
            <section id="condition-section">
                <div id="loading-status" class="loading-overlay" style="display: none;">
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <p class="loading-text">📊 データを読み込み中...</p>
                        <p class="loading-subtext">しばらくお待ちください</p>
                    </div>
                </div>
                <div id="sync-warning" style="display: none; text-align: center; margin: 15px 0; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; color: #856404;">
                    ⚠️ 共有履歴との同期に失敗しました。チーム間での重複選択の可能性があります。
                </div>
                <h2>条件を選択してください</h2>
                <div class="condition-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="no-ramen-filter" checked>
                        <span class="checkmark"></span>
                        ラーメン除外
                    </label>
                </div>
                <div class="condition-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="nearby-filter">
                        <span class="checkmark"></span>
                        近場の店舗に限定
                    </label>
                </div>
                <div class="condition-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="capacity-filter">
                        <span class="checkmark"></span>
                        4人以上入れる店舗に限定
                    </label>
                </div>
                <div class="condition-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="ignore-history-filter">
                        <span class="checkmark"></span>
                        履歴を考慮しない（お一人様の時ON）
                    </label>
                </div>
                <button id="decide-btn" class="primary-btn">ランチを決める！</button>
            </section>

            <!-- 結果表示エリア -->
            <section id="result-section" class="hidden">
                <h2>🎯 今日のランチは...</h2>
                <div id="result-card" class="result-card">
                    <h3 id="restaurant-name"></h3>
                    <div id="normal-restaurant-details" class="restaurant-details">
                        <p class="genre">🏷️ ジャンル: <span id="restaurant-genre"></span></p>
                        <p class="rating">⭐ 評価: <span id="restaurant-rating"></span></p>
                        <p class="memo" id="memo-section" style="display: none;">📝 メモ: <span id="restaurant-memo"></span></p>
                        <p class="location" id="location-section" style="display: none;">📍 場所: <span id="restaurant-location"></span></p>
                        <p class="url" id="url-section" style="display: none;">🔗 URL: <a id="restaurant-url" href="#" target="_blank" rel="noopener">リンクを開く</a></p>
                        <div class="conditions">
                            <span id="nearby-status" class="status-badge"></span>
                            <span id="capacity-status" class="status-badge"></span>
                        </div>
                    </div>
                    <div id="new-discovery-details" class="restaurant-details" style="display: none;">
                        <p class="discovery-message">🎯 新しいお店を探しに行きましょう！</p>
                        <div class="discovery-buttons">
                            <button id="nearby-map-btn" class="discovery-btn">📍 近隣のマップから探す</button>
                            <button id="akihabara-btn" class="discovery-btn">🚃 秋葉原駅周辺で探す</button>
                            <button id="ochanomizu-btn" class="discovery-btn">🍵 お茶の水駅周辺で探す</button>
                        </div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button id="retry-btn" class="secondary-btn">やり直し</button>
                    <button id="confirm-btn" class="primary-btn">確定</button>
                </div>
            </section>

            <!-- 今週の利用状況 -->
            <section id="weekly-status">
                <h3>📅 今週の利用状況</h3>
                <div id="weekly-grid" class="weekly-grid">
                    <div class="day-item"><strong>月:</strong> <span id="mon-status">-</span></div>
                    <div class="day-item"><strong>火:</strong> <span id="tue-status">-</span></div>
                    <div class="day-item"><strong>水:</strong> <span id="wed-status">-</span></div>
                    <div class="day-item"><strong>木:</strong> <span id="thu-status">-</span></div>
                    <div class="day-item"><strong>金:</strong> <span id="fri-status">-</span></div>
                    <div class="day-item"><strong>土:</strong> <span id="sat-status">-</span></div>
                    <div class="day-item"><strong>日:</strong> <span id="sun-status">-</span></div>
                </div>
            </section>

            <!-- 設定エリア -->
            <section id="settings-section">
                <details>
                    <summary>⚙️ 設定</summary>
                    <div class="settings-content">
                        <div class="setting-item">
                            <label>
                                星評価重み係数: 
                                <input type="range" id="rating-weight" min="1" max="3" step="0.1" value="1.5">
                                <span id="rating-weight-value">1.5</span>
                            </label>
                            <p class="setting-description">
                                高評価のお店がどれくらい選ばれやすくなるかを調整します<br>
                                1.0 = 評価に関係なく平等　1.5 = やや高評価優先　3.0 = 高評価大幅優先
                            </p>
                        </div>
                        
                        <div class="setting-item">
                            <label>
                                新規開拓の星評価: 
                                <input type="range" id="new-discovery-rating" min="1" max="5" step="0.5" value="1.5">
                                <span id="new-discovery-rating-value">1.5</span> ⭐
                            </label>
                            <p class="setting-description">
                                新規開拓を何星のお店として扱うかを設定します<br>
                                1.0⭐ = 選ばれにくい　3.0⭐ = 普通　5.0⭐ = 選ばれやすい
                            </p>
                        </div>
                        
                        <button id="reset-history-btn" class="danger-btn">履歴をリセット</button>
                    </div>
                </details>
            </section>
        </main>

        <footer>
            <p>Lunch Decider v1.0 | 
            <a href="https://github.com/ganta9/lunch-decider" target="_blank">GitHub</a></p>
        </footer>
    </div>

    <!-- 設定ファイルを最初に読み込み（エラーハンドリング付き） -->
    <script>
        // config.js が存在しない場合の警告
        window.onerror = function(msg, url, line, col, error) {
            if (msg.includes('config.js')) {
                console.warn('config.js が見つかりません。SECURITY_SETUP.md を参照して設定してください。');
                alert('設定ファイルが見つかりません。SECURITY_SETUP.md を参照して config.js を作成してください。');
            }
            return false;
        };
    </script>
    <script src="config.js" onerror="console.warn('config.js の読み込みに失敗しました')"></script>
    <script src="script.js"></script>
</body>
</html>